<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOROLAND â€“ Chapter 3: ë¨¸ì§€íë¸Œ ì† ë¹„ë°€</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- ì—¬ê¸°ì„œ ì™¸ë¶€ CSS íŒŒì¼ì„ ë¶ˆëŸ¬ì˜´ -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* íë¸Œ ë©´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (íŒ¨í„´ì€ JSë¡œ ì¡°ì ˆí•˜ì—¬ ê° ë©´ì˜ ì¼ë¶€ë§Œ ë³´ì´ê²Œ í•¨) */
    .cube .face {
      background-color: rgba(10,18,34,0.6);
      background-repeat: no-repeat;
      /* íŒ¨í„´ì„ í¬ê²Œ ì¡ì•„(4ë¶„í• ) ì •í™•í•œ ì˜ì—­ì„ ì„ íƒí•˜ë„ë¡ í•¨ */
      background-size: 400% 400%;
      background-position: 50% 50%;
      border: 1px solid rgba(41,216,255,0.12);
      box-shadow: inset 0 0 30px rgba(41,216,255,0.06);
      background-blend-mode: overlay;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      transition: background-position .38s ease, opacity .28s ease, filter .28s ease;
      opacity: 0.28; /* ì´ˆê¸°ì—ëŠ” í¬ë¯¸í•˜ê²Œ ë³´ì„ */
      filter: grayscale(.4) brightness(.9);
    }

    /* unlocked ë˜ì—ˆì„ ë•Œ ì„ ëª…í•˜ê²Œ ë³´ì´ë„ë¡ */
    .cube .face.face-unlocked {
      opacity: 1;
      filter: grayscale(.05) brightness(1.02) contrast(1.03);
      box-shadow: 0 0 40px rgba(41,216,255,.12) inset;
    }

    /* ë‚´ë¶€ ë©´(ê²¹ì³ ë³´ì´ëŠ” ë¶€ë¶„)ì€ ì¡°ê¸ˆ ë” íë¦¬ê²Œ */
    .cube--inner .face {
      opacity: 0.6;
      transform: translateZ(6px);
    }

    /* Vault ìŠ¬ë¡¯ ë‚´ ë¬¸ì–‘ ì˜ì—­ (íŒ¨í„´ì˜ ì¼ë¶€ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë°°ê²½ìœ¼ë¡œ ì²˜ë¦¬) */
    .vault .slot {
      /* ìŠ¬ë¡¯ ì „ì²´ í¬ê¸° ì—¬ìœ ë¥¼ ëŠ˜ë ¤ ê°€ë¡œë¡œ ê¸´ ì¹´ë“œì— ë§ì¶¤ */
      min-width: 140px;
      padding: 10px;
    }

    .vault .glyph {
      width: 100%;
      /* ì •ì‚¬ê° ë¹„ìœ¨ ìœ ì§€ â€” ìŠ¬ë¡¯ ë„ˆë¹„ì— ë§ì¶° ë†’ì´ê°€ ìë™ìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤ */
      aspect-ratio: 1 / 1;
      height: auto;
      max-height: 180px; /* ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ ìƒí•œ ì„¤ì • */
      border-radius: 10px;
      background-repeat: no-repeat;
      /* ì´ë¯¸ì§€ê°€ ìŠ¬ë¡¯ì„ ê°€ë“ ì±„ìš°ë„ë¡ cover ì‚¬ìš© */
      background-size: cover;
      background-position: center;
      transition: background-position .4s ease, opacity .3s ease, transform .28s ease;
      opacity: 0.0;
    }
    .vault .slot.is-found .glyph { opacity: 1; }
  </style>
</head>
<body>
  <div class="stars" aria-hidden="true"></div>

  <header>
    <div class="container nav">
      <div class="logo">DOROLAND</div>
      <nav class="menu" aria-label="ì£¼ìš” ì„¹ì…˜">
        <button class="nav-btn" type="button" data-id="hintHud">ë¬¸ì œ 1ë²ˆ íŒíŠ¸</button>
        <button class="nav-btn" type="button" data-id="hintMemory">ë¬¸ì œ 2ë²ˆ íŒíŠ¸</button>
        <button class="nav-btn" type="button" data-id="hintVital">ë¬¸ì œ 3ë²ˆ íŒíŠ¸</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero" aria-labelledby="title">
      <div>
        <div class="eyebrow">CHAPTER 3</div>
        <h1 id="title">ë¨¸ì§€íë¸Œ ì† ë¹„ë°€</h1>
        <p class="subtitle">ë¨¸ì§€íë¸Œ ì† ë¹„ë°€ì„ íŒŒí—¤ì¹˜ê³  íŒíŠ¸ë¥¼ ëª¨ì•„ ë¦¬ì½”ë¥¼ êµ¬ì¶œí•˜ì!</p>

        <div class="progress">
          <span>ì§„í–‰ë„</span>
          <div class="dots" role="status" aria-live="polite">
            <span class="dot" title="1/4"></span>
            <span class="dot" title="2/4"></span>
            <span class="dot" title="3/4"></span>
            <span class="dot" title="4/4"></span>
          </div>
          <span class="progress-count">0 / 4</span>
        </div>

        <!-- Glyph Vault: í¼ì¦ì„ í’€ ë•Œë§ˆë‹¤ ë¬¸ì–‘ 1ê°œì”© ì˜¤í”ˆ -->
        <div id="glyphVault" class="vault" aria-label="íšë“í•œ ë¬¸ì–‘">
          <div class="slot" data-step="1" aria-live="polite">
            <div class="slot-header">#1</div>
            <div class="glyph"></div>
            <div class="lock">LOCKED</div>
          </div>
          <div class="slot" data-step="2" aria-live="polite">
            <div class="slot-header">#2</div>
            <div class="glyph"></div>
            <div class="lock">LOCKED</div>
          </div>
          <div class="slot" data-step="3" aria-live="polite">
            <div class="slot-header">#3</div>
            <div class="glyph"></div>
            <div class="lock">LOCKED</div>
          </div>
          <div class="slot" data-step="4" aria-live="polite">
            <div class="slot-header">#4</div>
            <div class="glyph"></div>
            <div class="lock">LOCKED</div>
          </div>
        </div>
      </div>

      <!-- 6ë©´ í™€ë¡œê·¸ë¨ íë¸Œ -->
      <div class="holo" aria-hidden="true">
        <div class="ring"></div>
        <div class="cube-wrap">
          <div class="cube" role="img" aria-label="íšŒì „í•˜ëŠ” í™€ë¡œê·¸ë¨ íë¸Œ">
            <div class="face f-front"></div>
            <div class="face f-back"></div>
            <div class="face f-right"></div>
            <div class="face f-left"></div>
            <div class="face f-top"></div>
            <div class="face f-bottom"></div>

            <div class="cube--inner">
              <div class="face f-front"></div>
              <div class="face f-back"></div>
              <div class="face f-right"></div>
              <div class="face f-left"></div>
              <div class="face f-top"></div>
              <div class="face f-bottom"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="cards" aria-label="ë¯¸ì…˜ ì¹´ë“œ">
      <article class="card" id="hud" role="button" tabindex="0" aria-controls="modal" aria-haspopup="dialog">
        <div class="icon" aria-hidden="true"></div>
        <h3>ì²«ë²ˆì§¸ ê¸°ì–µ</h3>
        <p>í‰í™”ë¡œì›Œ ë³´ì´ëŠ” ëˆ„êµ°ê°€ì˜ ê¸°ì–µ, <br>
          ì–´ë–¤ ë¹„ë°€ì´ ìˆ¨ê²¨ì ¸ ìˆëŠ”ê±¸ê¹Œ</p>
      </article>

      <article class="card" id="memory" role="button" tabindex="0" aria-controls="modal" aria-haspopup="dialog">
        <div class="icon" aria-hidden="true"></div>
        <h3>ë‘ë²ˆì§¸ ê¸°ì–µ</h3>
        <p>ì´ í„°ì „ì„ íŒŒê´´í•˜ê³  ì¹¨ë²”í•œ ëˆ„êµ°ê°€...! <br>
          ì‚¬ì‹¤ ë„ë¡œëœë“œëŠ” ì´ë ‡ê²Œ ì§€ì–´ì§„ê±¸ê¹Œ?</p>
      </article>

      <article class="card" id="vital" role="button" tabindex="0" aria-controls="modal" aria-haspopup="dialog">
        <div class="icon" aria-hidden="true"></div>
        <h3>ì„¸ë²ˆì§¸ ê¸°ì–µ</h3>
        <p>ì—¬ê¸°ì— ë¦¬ì½”ê°€ ê°‡í˜€ìˆëŠ” ê²ƒ ê°™ë‹¤. <br>
          í•˜ì§€ë§Œ ì–´ë–»ê²Œ êµ¬ì¶œí•´ì•¼í•˜ì§€?</p>
      </article>

      <article class="card" id="tracker" role="button" tabindex="0" aria-controls="modal" aria-haspopup="dialog">
        <div class="icon" aria-hidden="true"></div>
        <h3>ì½”ë±ìŠ¤ì˜ ë¬¸ì–‘</h3>
        <p>ë§ì´ ë´ì™”ì§€ë§Œ, ì •ì²´ë¥¼ ì•Œ ìˆ˜ ì—†ì—ˆë˜ ë¬¸ì–‘ <br>
          ì´ì   ì§„ì‹¤ì— ê°€ê¹Œì›Œì§ˆ ì°¨ë¡€ë‹¤.</p>
      </article>
    </section>

    <p class="footer">DOROLAND</p>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">íƒ€ì´í‹€</div>
        <div><button id="modalClose" class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button></div>
      </div>
      <div id="modalBody" class="modal-body">ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ì›¹íˆ° ëª¨ë‹¬ -->
  <div id="webtoonModal" class="modal webtoon-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <div class="modal-title">DOROLAND</div>
      </div>
      <div class="modal-body">
        <img src="./mission_start.png" alt="ë¯¸ì…˜ ì‹œì‘ ì›¹íˆ°" class="webtoon-image">
        <p class="start-notice">
          ë¦¬ì½”ë¥¼ êµ¬í•˜ê¸° ìœ„í•´ ë¨¸ì§€íë¸Œ ì†ì˜ ë¹„ë°€ì„ íŒŒí—¤ì³ë´…ì‹œë‹¤!<br>
        </p>

        <!-- âœ… ì—¬ê¸° ìƒˆë¡œ ì¶”ê°€ -->
        <button class="btn mission-start" type="button">
          ë¯¸ì…˜ ì‹œì‘
        </button>
      </div>
    </div>
  </div>


  <!-- ë¬¸ì–‘ ê·¸ë¦¬ë“œ ëª¨ë‹¬ -->
  <div id="glyphGridModal" class="modal glyph-grid-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <div class="modal-title">ì²«ë²ˆì§¸ ê¸°ì–µ - í‰í™”ë¡œì›Œ ë³´ì´ëŠ” ì‚¬ëŒë“¤</div>
        <div><button class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button></div>
      </div>
      <div class="modal-body">
        <div class="glyph-grid-wrapper">
          <div class="glyph-grid-container" id="glyphGridContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR ë³´ìƒ ëª¨ë‹¬: ì •ë‹µ í›„ QR í™•ì¸í•˜ê³  'í™•ì¸' ë²„íŠ¼ ëˆ„ë¥´ë©´ ë¬¸ì–‘ íšë“ -->
  <div id="qrModal" class="modal qr-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document" style="max-width:420px;">
      <div class="modal-header">
        <div class="modal-title">ì²«ë²ˆì§¸ ê¸°ì–µ - QR ì½”ë“œ</div>
        <div><button id="qrClose" class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button></div>
      </div>
      <div class="modal-body" style="text-align:center;">
        <img id="qrImage" src="./1ë²ˆqr.png" alt="ì²«ë²ˆì§¸ ê¸°ì–µ QR ì½”ë“œ" style="max-width:88%;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.5)">
        <p style="color:var(--muted);margin-top:10px;">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ ë‹¤ìŒ ê¸°ì–µì„ í™•ì¸í•˜ì„¸ìš”.</p>
        <div style="margin-top:12px;">
          <button id="qrConfirmBtn" class="btn" type="button">í™•ì¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ìŠ¬ë¼ì´ë“œ í¼ì¦ ëª¨ë‹¬ (4ë²ˆì§¸ ê¸°ì–µìš©) -->
  <div id="slideModal" class="modal slide-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <div class="modal-title">ë„¤ë²ˆì§¸ ê¸°ì–µ: ì½”ë±ìŠ¤ ë¬¸ì–‘ ë³µì›</div>
        <div><button class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button></div>
      </div>
      <div class="modal-body">
        <div class="slide-puzzle-wrapper">
          <div class="slide-grid" id="slideGrid"></div>

          <div class="slide-info">
            <button id="resetSlidePuzzle" class="answer-btn" type="button">
              ë‹¤ì‹œ ì„ê¸°
            </button>
          </div>

          <div id="slideResult" class="result-message"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // pattern ì´ë¯¸ì§€ ê²½ë¡œ (í”„ë¡œì íŠ¸ í´ë”ì— codex_pattern.png ë„£ì–´ë‘ì„¸ìš”)
    const patternURL = './codex_pattern.png';

    // ë°°ê²½ìŒì•… ì„¤ì • (íŒŒì¼: bgm.mp3 ë¥¼ ê°™ì€ í´ë”ì— ë„£ìœ¼ì„¸ìš”)
    const bgmEl = document.createElement('audio');
    bgmEl.id = 'bgmElement';
    bgmEl.src = './bgm.mp3';
    bgmEl.loop = true;
    bgmEl.preload = 'auto';
    bgmEl.volume = 0.24;
    bgmEl.style.display = 'none';
    document.body.appendChild(bgmEl);

    // í•­ìƒ ì¬ìƒë˜ë„ë¡ ì„¤ì • (ë¸Œë¼ìš°ì € ì •ì±…ì— ë”°ë¼ ìë™ì¬ìƒì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ)
    bgmEl.autoplay = true;
    bgmEl.muted = false;
    // ì‹œë„ ì¬ìƒ (ì°¨ë‹¨ë˜ë©´ ë¬´ì‹œ)
    bgmEl.play().catch(()=>{ /* autoplay ì°¨ë‹¨ ì‹œ ë¬´ì‹œ */ });
    
    // --- íŒ¨í„´ ì´ë¯¸ì§€ íŒŒì¼ ë§¤í•‘ (codex_pattern_1-1.png ~ codex_pattern_1-4.png) ---
    const patternForStep = {
      1: './codex_pattern_1-1.png',
      2: './codex_pattern_1-2.png',
      3: './codex_pattern_1-3.png',
      4: './codex_pattern_1-4.png'
    };

    // íë¸Œ face ë§¤í•‘ (í•„ìš”ì‹œ ì…€ë ‰í„°ë¥¼ ì¡°ì •)
    const faceMap = { 1: '.cube .f-front', 2: '.cube .f-right', 3: '.cube .f-top', 4: '.cube .f-back' };

    // íë¸Œ ë©´ë³„ ë¯¸ì„¸ ìœ„ì¹˜ ë³´ì • (background-position) â€” í•„ìš”í•˜ë©´ ê°’ ì¡°ì •
    const cubeFacePos = {
      1: '50% 50%',
      2: '50% 50%',
      3: '50% 50%',
      4: '50% 50%'
    };

    // ìŠ¬ë¡¯ê³¼ íë¸Œì—ì„œ ì‚¬ìš©í•  background-size â€” í•„ìš”ì‹œ 'cover'/'contain' ë˜ëŠ” í¼ì„¼íŠ¸ë¡œ ë³€ê²½
    const SLOT_BG_SIZE = 'cover';
    const CUBE_BG_SIZE = 'cover';

    // ì¡°ì • ê°€ëŠ¥í•œ ê¸°ì¤€ ê°’ (í•„ìš”í•˜ë©´ ìˆ«ìë§Œ ë°”ê¿”ì„œ ë¯¸ì„¸ì¡°ì •í•˜ì„¸ìš”)
    // const SLOT_BG_SIZE = '400% 400%';    // ìŠ¬ë¡¯ì—ì„œ íŒ¨í„´ì„ ì–¼ë§ˆë‚˜ í¬ê²Œ ì¡ì„ì§€
    // const CUBE_BG_SIZE = '350% 350%';    // íë¸Œì—ì„œ íŒ¨í„´ í¬ê¸° (3D ë³´ì • ë•Œë¬¸ì— ìŠ¬ë¡¯ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)

    // ë” ì •ë°€í•œ ìœ„ì¹˜ ë§¤í•‘ â€” ìŠ¬ë¡¯(ì™¼ìª½ ê·¸ë¦¬ë“œ)ê³¼ íë¸Œ(ìš°ì¸¡ í™€ë¡œê·¸ë¨)ì— ê°ê° ë‹¤ë¥¸ í¬ì§€ì…˜ì„ ì¤ë‹ˆë‹¤.
    // í•„ìš”í•˜ë©´ ì—¬ê¸° ê°’ì„ ì§ì ‘ ë°”ê¿”ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë§ì¶°ë³´ì„¸ìš”.
    const slotPatternPos = {
      1: '18% 62%', // ìŠ¬ë¡¯ #1 - (ì˜ˆ: ì™¼ìª½ ìœ„ì˜ ë¬¸ì–‘ ì¼ë¶€)
      2: '52% 62%', // ìŠ¬ë¡¯ #2
      3: '18% 82%', // ìŠ¬ë¡¯ #3
      4: '52% 82%'  // ìŠ¬ë¡¯ #4
    };

    const cubePatternPos = {
      1: '20% 58%', // íë¸Œ front ë³´ì •ê°’
      2: '78% 58%', // íë¸Œ right ë³´ì •ê°’
      3: '22% 78%', // íë¸Œ top ë³´ì •ê°’
      4: '78% 78%'  // íë¸Œ back ë³´ì •ê°’
    };

    /* ===== Glyph Vault Logic ===== */
    const stepOrder = { hud:1, memory:2, vital:3, tracker:4 };
    const idForStep = Object.fromEntries(Object.entries(stepOrder).map(([k,v])=>[v,k]));

    const glyphSVG = {
      hex:`<svg viewBox="0 0 200 200" role="img" aria-label="ìœ¡ê° ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
          <polygon points="100,12 176,56 176,144 100,188 24,144 24,56"/>
          <polygon points="100,32 158,66 158,134 100,168 42,134 42,66" opacity=".8"/>
          <polygon points="100,52 140,76 140,124 100,148 60,124 60,76" opacity=".55"/>
          <path d="M100 68 L100 132 M84 100 L116 100" opacity=".9"/>
        </g></svg>`,
      spiral:`<svg viewBox="0 0 200 200" role="img" aria-label="ìŠ¤íŒŒì´ëŸ´ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <path d="M100,40 c35,0 60,25 60,60 c0,28-22,50-50,50 c-25,0-44-19-44-44 c0,-20 16-36 36-36 c16,0 28,12 28,28 c0,12-10,22-22,22 c-10,0-18-8-18-18"/>
          <circle cx="100" cy="100" r="4" fill="currentColor"/>
        </g></svg>`,
      tri:`<svg viewBox="0 0 200 200" role="img" aria-label="ì‚¼ê° ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3" stroke-linejoin="round">
          <polygon points="100,20 180,160 20,160"/>
          <polygon points="100,40 160,150 40,150" opacity=".75"/>
          <polygon points="100,60 140,140 60,140" opacity=".55"/>
          <path d="M100 80 L120 120 L80 120 Z" opacity=".9"/>
        </g></svg>`,
      wave:`<svg viewBox="0 0 200 200" role="img" aria-label="íŒŒë™ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <path d="M10 120 q20-40 40 0 t40 0 t40 0 t40 0" />
          <path d="M10 80  q20-40 40 0 t40 0 t40 0 t40 0" opacity=".6"/>
          <path d="M10 100 q20-40 40 0 t40 0 t40 0 t40 0" opacity=".3"/>
          <circle cx="100" cy="100" r="6" fill="currentColor" />
        </g></svg>`,
      grid:`<svg viewBox="0 0 200 200" role="img" aria-label="ê·¸ë¦¬ë“œ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <rect x="30" y="30" width="140" height="140" rx="10"/>
          <path d="M30 70H170 M30 110H170 M30 150H170 M70 30V170 M110 30V170 M150 30V170" opacity=".6"/>
          <rect x="86" y="86" width="28" height="28" rx="6" />
        </g></svg>`,
      star:`<svg viewBox="0 0 200 200" role="img" aria-label="ìŠ¤íƒ€ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3" stroke-linejoin="round" stroke-linecap="round">
          <path d="M100 18 L118 74 L176 74 L128 108 L146 164 L100 130 L54 164 L72 108 L24 74 L82 74 Z" />
          <circle cx="100" cy="100" r="10" />
        </g></svg>`,
      diamond:`<svg viewBox="0 0 200 200" role="img" aria-label="ë‹¤ì´ì•„ëª¬ë“œ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <polygon points="100,20 160,100 100,180 40,100"/>
          <polygon points="100,40 140,100 100,160 60,100" opacity=".7"/>
          <path d="M100 80 L100 120 M80 100 L120 100" opacity=".5"/>
        </g></svg>`,
      pulse:`<svg viewBox="0 0 200 200" role="img" aria-label="í„ìŠ¤ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <circle cx="100" cy="100" r="20"/>
          <circle cx="100" cy="100" r="50" opacity=".6"/>
          <circle cx="100" cy="100" r="80" opacity=".3"/>
          <path d="M100 40 L100 160 M40 100 L160 100" opacity=".4"/>
        </g></svg>`,
      fractal:`<svg viewBox="0 0 200 200" role="img" aria-label="í”„ë™íƒˆ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="2">
          <rect x="30" y="30" width="140" height="140" rx="8"/>
          <rect x="50" y="50" width="100" height="100" rx="6" opacity=".7"/>
          <rect x="70" y="70" width="60" height="60" rx="4" opacity=".5"/>
          <rect x="85" y="85" width="30" height="30" rx="2" opacity=".3"/>
        </g></svg>`,
      void:`<svg viewBox="0 0 200 200" role="img" aria-label="ë³´ì´ë“œ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3">
          <circle cx="100" cy="100" r="70"/>
          <circle cx="100" cy="100" r="50" opacity=".5"/>
          <circle cx="100" cy="100" r="30" opacity=".3"/>
          <circle cx="100" cy="100" r="10" fill="currentColor"/>
        </g></svg>`,
      prism:`<svg viewBox="0 0 200 200" role="img" aria-label="í”„ë¦¬ì¦˜ ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="3" stroke-linejoin="round">
          <polygon points="100,30 160,170 40,170"/>
          <line x1="100" y1="30" x2="100" y2="170"/>
          <line x1="60" y1="110" x2="140" y2="110"/>
          <line x1="50" y1="150" x2="150" y2="150" opacity=".5"/>
        </g></svg>`,
      echo:`<svg viewBox="0 0 200 200" role="img" aria-label="ì—ì½” ë¬¸ì–‘">
        <g fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="100" cy="100" r="15" fill="currentColor"/>
          <circle cx="100" cy="100" r="35" opacity=".7"/>
          <circle cx="100" cy="100" r="55" opacity=".4"/>
          <circle cx="100" cy="100" r="75" opacity=".15"/>
        </g></svg>`
    };

    const rewardForStep = { 1:'hex', 2:'wave', 3:'grid', 4:'star' };
    const acquired = [false,false,false,false];
    const vault = document.getElementById('glyphVault');
    const dots = Array.from(document.querySelectorAll('.progress .dots .dot'));
    const progressText = document.querySelector('.progress .progress-count');
    
    function ensureGlyphModalUI(){
      const body = glyphGridModal.querySelector('.modal-body');
      // ì„ íƒ ì¹´ìš´í„° & ëª©ë¡
      if (!document.getElementById('selectedCount')) {
        const tracker = document.createElement('div');
        tracker.className = 'selection-tracker';
        tracker.innerHTML = `
          <div class="selection-tracker-item">
            <span class="selection-tracker-label">ì„ íƒ</span>
            <span id="selectedCount" class="selection-tracker-value">0/3</span>
          </div>
          <div id="selectedGlyphsDisplay"></div>`;
        body.appendChild(tracker);
      }
      // ê²°ê³¼ ë©”ì‹œì§€
      if (!document.getElementById('resultMessage')) {
        const msg = document.createElement('div');
        msg.id = 'resultMessage';
        msg.className = 'result-message';
        msg.setAttribute('role','alert');
        body.appendChild(msg);
      }
    }

    function revealGlyph(step, id){
      const slot = vault.querySelector(`.slot[data-step="${step}"]`);
      if(!slot) return;
      if (slot.classList.contains('is-found')) return;

      // ìŠ¬ë¡¯ì— í•´ë‹¹ step ì „ìš© ì´ë¯¸ì§€ ì ìš© (íŒŒì¼: patternForStep[step])
      const patternSrc = patternForStep[step];
      const glyphEl = slot.querySelector('.glyph');
      // clear any inline svg content (we show the bitmap piece)
      glyphEl.innerHTML = '';
      glyphEl.style.backgroundImage = patternSrc ? `url('${patternSrc}')` : '';
      glyphEl.style.backgroundSize = SLOT_BG_SIZE;
      glyphEl.style.backgroundPosition = 'center';
      glyphEl.style.backgroundRepeat = 'no-repeat';

      // ìŠ¬ë¡¯ ìƒíƒœ ì—…ë°ì´íŠ¸ & íš¨ê³¼
      slot.classList.add('is-found', 'slot-reveal');
      setTimeout(() => slot.classList.remove('slot-reveal'), 800);

      // ì¹´ë“œ(ë¬¸ì œ)ë„ ì™„ë£Œ í‘œì‹œ
      const cardId = idForStep[step];
      if(cardId){
        const cardEl = document.getElementById(cardId);
        if(cardEl) {
          cardEl.classList.add('is-complete', 'reveal-icon');
          cardEl.setAttribute('aria-disabled','true');
          setTimeout(() => cardEl.classList.remove('reveal-icon'), 900);
        }
      }

      // ìŠ¬ë¡¯ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
      glyphEl.style.animation = 'glyphPop .38s ease';

      // í™€ë¡œê·¸ë¨ íë¸Œì˜ í•´ë‹¹ ë©´ë„ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
      const faceSelector = faceMap[step];
      const faceEl = document.querySelector(faceSelector);
      if(faceEl && patternSrc){
        faceEl.style.backgroundImage = `url('${patternSrc}')`;
        faceEl.style.backgroundSize = CUBE_BG_SIZE;
        faceEl.style.backgroundPosition = cubeFacePos[step] || '50% 50%';
        faceEl.style.backgroundRepeat = 'no-repeat';
        faceEl.classList.add('face-unlocked');
      }
      // ë‚´ë¶€(inner) ë©´ë„ ë™ì¼ ì²˜ë¦¬(ì¡´ì¬í•˜ë©´)
      const innerFaceEl = document.querySelector('.cube--inner ' + (faceSelector.replace('.cube ','').trim()));
      if(innerFaceEl && patternSrc){
        innerFaceEl.style.backgroundImage = `url('${patternSrc}')`;
        innerFaceEl.style.backgroundSize = CUBE_BG_SIZE;
        innerFaceEl.style.backgroundPosition = cubeFacePos[step] || '50% 50%';
        innerFaceEl.style.backgroundRepeat = 'no-repeat';
        innerFaceEl.classList.add('face-unlocked');
      }
      
      // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
      acquired[step-1] = true;
      const count = acquired.filter(Boolean).length;
  
      dots.forEach((d,i)=> {
        const isActive = i < count;
        const wasActive = d.classList.contains('is-active');
        d.classList.toggle('is-active', isActive);
  
        // ìƒˆë¡œ ì¼œì§€ëŠ” ì ì—ë§Œ flash íš¨ê³¼ ì£¼ê¸°
        if (isActive && !wasActive) {
          d.classList.add('dot-flash');
          setTimeout(() => d.classList.remove('dot-flash'), 600);
        }
      });
  
      if(progressText) progressText.textContent = `${count} / 4`;
    }


  /* ===== ë¬¸ì–‘ ê·¸ë¦¬ë“œ ê´€ë ¨ ===== */
  const glyphGridModal = document.getElementById('glyphGridModal');
const glyphGridContainer = document.getElementById('glyphGridContainer');
const glyphPatterns = ['hex', 'spiral', 'tri', 'wave', 'grid', 'star', 'diamond', 'pulse', 'fractal', 'void', 'prism', 'echo'];

/* ğŸ”¥ ë¬¸ì–‘ ê·¸ë¦¬ë“œ ìƒíƒœ ë³€ìˆ˜ */
let selectedGlyphs = [];
const correctOrder = [0, 1, 2];   // ì •ë‹µ ì¸ë±ìŠ¤
let isAnswerPhase = false;

/* ğŸ”¥ ë¬¸ì–‘ ì¹´ë“œ ê·¸ë¦¬ë“œ ì±„ìš°ê¸° */
function populateGlyphGrid() {
  ensureGlyphModalUI();                // ì„ íƒ ì¹´ìš´í„°/ê²°ê³¼ ë©”ì‹œì§€ ë³´ì¥
  glyphGridContainer.innerHTML = '';
  selectedGlyphs = [];
  isAnswerPhase = false;

  glyphPatterns.forEach((pattern, index) => {
    const card = document.createElement('div');
    card.className = 'glyph-card';
    card.dataset.pattern = pattern;
    card.dataset.index = index;
    card.innerHTML = glyphSVG[pattern];

    card.addEventListener('click', () => selectGlyph(pattern, card, index));
    glyphGridContainer.appendChild(card);
  });
}

    /* ===== ìŠ¬ë¼ì´ë“œ í¼ì¦ (4ë²ˆì§¸ ê¸°ì–µìš©) ===== */

  const slideModal = document.getElementById('slideModal');
  const slideGrid = document.getElementById('slideGrid');
  const moveCountEl = document.getElementById('moveCount');
  const slideResult = document.getElementById('slideResult');
  const resetSlideBtn = document.getElementById('resetSlidePuzzle');
  const slideModalClose = slideModal.querySelector('.modal-close');

  const SLIDE_SIZE = 3;
  const EMPTY_TILE = 8; // 0~8 ì¤‘ ë§ˆì§€ë§‰ ì¹¸ì„ ë¹ˆì¹¸ìœ¼ë¡œ ì‚¬ìš©

  let slideBoard = [];  // í˜„ì¬ í¼ì¦ ìƒíƒœ (ê¸¸ì´ 9, ê°’ 0~8)

  // í¼ì¦ ì´ˆê¸°í™”
  function initSlidePuzzle() {
    // í•´ë‹µ ìƒíƒœë¡œ ì‹œì‘
    slideBoard = [0,1,2,3,4,5,6,7,8];
    shuffleSlideBoard();
    slideResult.classList.remove('show', 'correct', 'incorrect');
    renderSlideBoard();
  }

  // ë³´ë“œ ì„ê¸° (í•­ìƒ í’€ ìˆ˜ ìˆëŠ” ìƒíƒœë¡œ)
function shuffleSlideBoard() {
  do {
    slideBoard = [0,1,2,3,4,5,6,7,8];
    for (let i = slideBoard.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [slideBoard[i], slideBoard[j]] = [slideBoard[j], slideBoard[i]];
    }
  } while (!isSlideSolvable(slideBoard) || isSlideSolved(slideBoard));
}

// 3Ã—3 ìŠ¬ë¼ì´ë“œ í¼ì¦ solvable ì²´í¬
function isSlideSolvable(board) {
  let inv = 0;
  for (let i = 0; i < 9; i++) {
    for (let j = i + 1; j < 9; j++) {
      if (board[i] === EMPTY_TILE || board[j] === EMPTY_TILE) continue;
      if (board[i] > board[j]) inv++;
    }
  }
  // 3Ã—3(í™€ìˆ˜)ì—ì„œëŠ” inversionì´ ì§ìˆ˜ë©´ solvable
  return inv % 2 === 0;
}

function isSlideSolved(board) {
  return board.every((v, i) => v === i);
}

// í™”ë©´ì— ë³´ë“œ ê·¸ë¦¬ê¸°
function renderSlideBoard() {
  slideGrid.innerHTML = '';

  slideBoard.forEach((tileIndex, pos) => {
    if (tileIndex === EMPTY_TILE) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'slide-tile empty';
      slideGrid.appendChild(emptyDiv);
    } else {
      const tile = document.createElement('div');
      tile.className = 'slide-tile';
      tile.dataset.index = tileIndex;

      const row = Math.floor(tileIndex / SLIDE_SIZE);
      const col = tileIndex % SLIDE_SIZE;
      // ë°°ê²½ì—ì„œ í•´ë‹¹ ì¡°ê° ìœ„ì¹˜ ë³´ì—¬ì£¼ê¸°
      tile.style.backgroundPosition = `${col * 50}% ${row * 50}%`;

      tile.addEventListener('click', () => handleSlideTileClick(pos));
      slideGrid.appendChild(tile);
    }
  });
}

// íƒ€ì¼ í´ë¦­ ì²˜ë¦¬
function handleSlideTileClick(pos) {
  const emptyPos = slideBoard.indexOf(EMPTY_TILE);
  if (!isAdjacentSlide(pos, emptyPos)) return;

  [slideBoard[pos], slideBoard[emptyPos]] = [slideBoard[emptyPos], slideBoard[pos]];
  renderSlideBoard();

  if (isSlideSolved(slideBoard)) {
    slideResult.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ì½”ë±ìŠ¤ ë¬¸ì–‘ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.';
    slideResult.classList.remove('incorrect');
    slideResult.classList.add('show', 'correct');

    setTimeout(() => {
      // 4ë²ˆì§¸ ë¬¸ì–‘ ì˜¤í”ˆ
      revealGlyph(4, 'star');   // rewardForStep[4]ê°€ 'star'ì¸ ìƒíƒœ
      closeSlideModal();
    }, 1200);
  }
}

// ì¸ì ‘(ìƒí•˜ì¢Œìš°) ì—¬ë¶€ ì²´í¬
function isAdjacentSlide(a, b) {
  const ax = a % SLIDE_SIZE, ay = Math.floor(a / SLIDE_SIZE);
  const bx = b % SLIDE_SIZE, by = Math.floor(b / SLIDE_SIZE);
  return Math.abs(ax - bx) + Math.abs(ay - by) === 1;
}

// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
function openSlideModal() {
  initSlidePuzzle();
  slideModal.classList.add('show');
  slideModal.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
  slideModalClose.focus();
}

function closeSlideModal() {
  slideModal.classList.remove('show');
  slideModal.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
  if (lastFocusedCard) lastFocusedCard.focus();
}

// ë²„íŠ¼ ë° ë°°ê²½ í´ë¦­ ì´ë²¤íŠ¸
resetSlideBtn.addEventListener('click', () => initSlidePuzzle());
slideModalClose.addEventListener('click', closeSlideModal);
slideModal.addEventListener('click', e => {
  if (e.target === slideModal) closeSlideModal();
});

    function selectGlyph(pattern, cardElement, index) {
      if (isAnswerPhase) return;
      
      const isAlreadySelected = selectedGlyphs.some(s => s.index === index);
      
      if (isAlreadySelected) {
        selectedGlyphs = selectedGlyphs.filter(s => s.index !== index);
        cardElement.classList.remove('selected');
        cardElement.removeAttribute('data-order');
      } else if (selectedGlyphs.length < 3) {
        selectedGlyphs.push({ pattern, index });
        cardElement.classList.add('selected');
        cardElement.setAttribute('data-order', selectedGlyphs.length);
        
        if (selectedGlyphs.length === 3) {
          setTimeout(() => checkAnswer(), 500);
        }
      }

      updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
      const selectedCount = document.getElementById('selectedCount');
      const selectedGlyphsDisplay = document.getElementById('selectedGlyphsDisplay');

      selectedCount.textContent = `${selectedGlyphs.length}/3`;
      
      selectedGlyphsDisplay.innerHTML = '';
      selectedGlyphs.forEach((s, idx) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '4px';
        item.style.padding = '6px 10px';
        item.style.background = 'rgba(41, 216, 255, 0.15)';
        item.style.borderRadius = '6px';
        item.style.border = '1px solid rgba(41, 216, 255, 0.3)';
        item.innerHTML = `<span style="color: var(--magenta); font-weight: 800; font-size: 14px;">${idx + 1}</span><span style="color: var(--text); font-weight: 600;">${s.pattern.toUpperCase()}</span>`;
        selectedGlyphsDisplay.appendChild(item);
      });
    }

    function checkAnswer() {
      isAnswerPhase = true;
      ensureGlyphModalUI();
      const resultMessage = document.getElementById('resultMessage');

      const selectedIndexes = selectedGlyphs.map(s => s.index);
      const isCorrect = 
        selectedIndexes[0] === correctOrder[0] &&
        selectedIndexes[1] === correctOrder[1] &&
        selectedIndexes[2] === correctOrder[2];

      resultMessage.classList.add('show');
      
      if (isCorrect) {
        resultMessage.classList.remove('incorrect');
        resultMessage.classList.add('correct');
        resultMessage.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ì¶•í•˜í•©ë‹ˆë‹¤!';
        
        selectedGlyphs.forEach(s => {
          const card = glyphGridContainer.querySelector(`[data-index="${s.index}"]`);
          if (card) {
            card.style.boxShadow = '0 0 30px rgba(0, 255, 150, 0.8), inset 0 0 20px rgba(0, 255, 150, 0.3)';
            card.style.borderColor = '#00ff9a';
          }
        });
        
        glyphGridContainer.querySelectorAll('.glyph-card').forEach(card => {
          if (!selectedGlyphs.some(s => s.index === parseInt(card.dataset.index))) {
            card.classList.add('disabled');
          }
        });

        // ì •ë‹µ ì²˜ë¦¬: ì ì‹œ í›„ QR ëª¨ë‹¬ì„ ë„ìš°ê³ ,
        // ì‚¬ìš©ìê°€ 'í™•ì¸'ì„ ëˆ„ë¥´ë©´ ë¬¸ì–‘ì„ íšë“í•˜ë„ë¡ ë³€ê²½
        setTimeout(() => {
          openQRModal(1); // step 1ì˜ QR ë³´ìƒ (ì´ë¯¸ì§€: ./1ë²ˆqr.png)
        }, 900);
      } else {
        resultMessage.classList.remove('correct');
        resultMessage.classList.add('incorrect');
        resultMessage.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        
        selectedGlyphs.forEach(s => {
          const card = glyphGridContainer.querySelector(`[data-index="${s.index}"]`);
          if (card) {
            card.style.animation = 'shake 0.4s ease';
          }
        });

        setTimeout(() => {
          selectedGlyphs = [];
          isAnswerPhase = false;
          glyphGridContainer.querySelectorAll('.glyph-card').forEach(card => {
            card.classList.remove('selected', 'disabled');
            card.removeAttribute('data-order');
            card.style.boxShadow = '';
            card.style.borderColor = '';
            card.style.animation = '';
          });
          updateSelectionDisplay();
          resultMessage.classList.remove('show');
        }, 2500);
      }
    }

    /* ===== Modal & ì¹´ë“œ/ë²„íŠ¼ ë°”ì¸ë”© ===== */
    const contents = {
      hud:{ title:'ì²«ë²ˆì§¸ ê¸°ì–µ', type:'glyph' },
      memory:{ title:'ë‘ë²ˆì§¸ ê¸°ì–µ'},
      vital:{ title:'ì„¸ë²ˆì§¸ ê¸°ì–µ'},
      tracker:{ title:'ë„¤ë²ˆì§¸ ê¸°ì–µ', type:'slide' },
      hintHud:{ title:'ì²«ë²ˆì§¸ ê¸°ì–µ íŒíŠ¸', html:'<p>ë¬´ìŠ¨ íŒíŠ¸ë¥¼ ì¤„ê¹Œ</p>' },
      hintMemory:{ title:'ë‘ë²ˆì§¸ ê¸°ì–µ íŒíŠ¸', html:'<p>ë¬´ìŠ¨ íŒíŠ¸ë¥¼ ì¤„ê¹Œ.</p>' },
      hintVital:{ title:'ì„¸ë²ˆì§¸ ê¸°ì–µ íŒíŠ¸', html:'<p>ë¬´ìŠ¨ íŒíŠ¸ë¥¼ ì¤„ê¹Œ.</p>' }
    };

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    const glyphModalClose = glyphGridModal.querySelector('.modal-close');
    let lastFocusedCard = null;
    
    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ë° ë°±ê·¸ë¼ìš´ë“œ í´ë¦­ ë°”ì¸ë”©
    if (modalClose) modalClose.addEventListener('click', closeModal);
    if (modal) modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    if (glyphModalClose) glyphModalClose.addEventListener('click', closeGlyphModal);
    if (glyphGridModal) glyphGridModal.addEventListener('click', e => { if (e.target === glyphGridModal) closeGlyphModal(); });
    // ESCë¡œ ë‹«ê¸° (ëª¨ë‹¬ì´ ì—´ë¦° ê²½ìš°)
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (modal.classList.contains('show')) closeModal();
        if (glyphGridModal.classList.contains('show')) closeGlyphModal();
        if (qrModal && qrModal.classList.contains('show')) closeQRModal();
        if (slideModal && slideModal.classList.contains('show')) closeSlideModal();
      }
    });

    function openModalFor(id){
      const data = contents[id] || { title:'ì •ë³´', html:'<p>ê´€ë ¨ ì •ë³´ ì—†ìŒ.</p>' };
      
      if(data.type === 'glyph'){
        populateGlyphGrid();
        glyphGridModal.classList.add('show');
        glyphGridModal.setAttribute('aria-hidden','false');
        glyphModalClose.focus();
        document.body.style.overflow = 'hidden';
      } 
      else if (data.type === 'slide') {
        openSlideModal();
      }
      else {
        modalTitle.textContent = data.title;
        modalBody.innerHTML = data.html;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
        modalClose.focus();
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      if (lastFocusedCard) lastFocusedCard.focus();
    }

    function closeGlyphModal(){
      glyphGridModal.classList.remove('show');
      glyphGridModal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      if (lastFocusedCard) lastFocusedCard.focus();
    }

    document.querySelectorAll('.card[role="button"]').forEach(card=>{
      card.addEventListener('click', e=>{ lastFocusedCard = e.currentTarget; openModalFor(card.id); });
      card.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); lastFocusedCard = e.currentTarget; openModalFor(card.id); }
      });
    });

    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{ lastFocusedCard = e.currentTarget; openModalFor(btn.dataset.id); });
      btn.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); lastFocusedCard = e.currentTarget; openModalFor(btn.dataset.id); }
      });
    });

    // QR ëª¨ë‹¬ í•¸ë“¤ë§
    const qrModal = document.getElementById('qrModal');
    const qrConfirmBtn = document.getElementById('qrConfirmBtn');
    const qrCloseBtn = document.getElementById('qrClose');
    const qrImage = document.getElementById('qrImage');

    function openQRModal(step) {
      // step ì¸ì ë³´ê´€
      qrModal.dataset.step = String(step || 1);
      // ì´ë¯¸ì§€ëŠ” ê³ ì • íŒŒì¼(./1ë²ˆ_qr.png)ìœ¼ë¡œ ì‚¬ìš© â€” í•„ìš” ì‹œ ê²½ë¡œ ë§¤í•‘ í™•ì¥ ê°€ëŠ¥
      qrImage.src = './1ë²ˆqr.png';
      qrModal.classList.add('show');
      qrModal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      qrConfirmBtn.focus();
    }

    function closeQRModal() {
      qrModal.classList.remove('show');
      qrModal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      if (lastFocusedCard) lastFocusedCard.focus();
    }

    qrConfirmBtn.addEventListener('click', () => {
      const step = parseInt(qrModal.dataset.step || '1', 10);
      // QR í™•ì¸ í›„ ë¬¸ì–‘ íšë“
      revealGlyph(step, rewardForStep[step] || 'hex');
      closeQRModal();
      // ê·¸ë¦¬ê³  ê·¸ë¦¬ë“œ ëª¨ë‹¬ë„ ë‹«ê¸°
      closeGlyphModal();
    });

    qrCloseBtn.addEventListener('click', () => {
      // ë‹«ê¸°ë§Œ: ëª¨ë‹¬ ë³µê·€í•´ì„œ ê³„ì† ì¬ë„ì „ ê°€ëŠ¥
      closeQRModal();
    });

    qrModal.addEventListener('click', e => { if (e.target === qrModal) closeQRModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && qrModal.classList.contains('show')) closeQRModal(); });

  </script>
</body>
</html>
